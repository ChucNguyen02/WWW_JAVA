<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="layout/base :: head"></head>
<body>
  <div th:replace="layout/base :: content" th:with="contentFragment=${{content: 'content'}}">
    <div th:fragment="content">
      <div class="row">
        <div class="col-md-5">
          <img th:src="@{/images/default-product.jpg}" class="img-fluid rounded" alt="product image"/>
        </div>
        <div class="col-md-7">
          <h2 th:text="${product.name}">Product</h2>
          <p class="text-muted" th:text="${product.category.name}">Category</p>
          <p class="fw-bold fs-4" th:text="${#numbers.formatDecimal(product.price,1,2)}">0.00</p>
          <p>
            <span class="badge" th:classappend="${product.stockQuantity > 0 ? ' bg-success' : ' bg-danger'}"
                  th:text="${product.stockQuantity > 0 ? 'Còn hàng' : 'Hết hàng'}">Status</span>
          </p>

          <form th:action="@{/cart/add}" method="post" class="row g-2 align-items-center">
            <div class="col-auto">
              <input type="number" name="quantity" value="1" min="1" class="form-control" style="width:90px"/>
            </div>
            <div class="col-auto">
              <input type="hidden" name="productId" th:value="${product.id}"/>
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <button class="btn btn-primary" type="submit" th:disabled="${product.stockQuantity <= 0}">Thêm vào giỏ</button>
            </div>
          </form>
        </div>
      </div>

      <hr/>

      <section>
        <h4>Đánh giá</h4>
        <div th:each="c : ${comments}" class="mb-2">
          <div class="card">
            <div class="card-body">
              <h6 class="card-title" th:text="${c.author.username}">user</h6>
              <p class="card-text" th:text="${c.text}">comment</p>
              <small class="text-muted" th:text="${#dates.format(c.createdAt.time,'dd/MM/yyyy HH:mm')}">date</small>
              <div class="mt-1" sec:authorize="authentication.name == c.author.username or hasRole('ADMIN')">
                <a class="btn btn-sm btn-outline-danger" th:href="@{/user/comment/delete/{commentId}(commentId=${c.id}, productId=${product.id})}">Xóa</a>
              </div>
            </div>
          </div>
        </div>

        <div sec:authorize="isAuthenticated()">
          <form th:action="@{/user/comment/post}" method="post">
            <input type="hidden" name="productId" th:value="${product.id}"/>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div class="mb-2">
              <textarea class="form-control" name="text" rows="3" placeholder="Viết đánh giá..."></textarea>
            </div>
            <button class="btn btn-success" type="submit">Gửi đánh giá</button>
          </form>
        </div>
        <div sec:authorize="isAnonymous()">
          <p><a th:href="@{/login}">Đăng nhập</a> để đánh giá sản phẩm.</p>
        </div>
      </section>
    </div>
  </div>
</body>
</html>